<!DOCTYPE html>
<html>
    <head>
        <title>Physics!</title>
        <script src="physics.js"></script>
        <script src="helpLib.js"></script>
        <script src="stats.js"></script>
        <meta charset="utf-8">
    </head>
    <body>
        <button onclick="if (document.getElementById('settings').style.display == 'none') {document.getElementById('settings').style.display = 'block'; this.innerHTML = 'Hide Settings';} else {document.getElementById('settings').style.display = 'none'; this.innerHTML = 'Show Settings'}" style="position: absolute; top: 2px; left: 60px;">Show Settings</button>
        <div id="settings" style="display:none">
            <br>
            <label for="collisionacc">Collision Accuracy (lower is more accurate):</label>
            <input type="range" name="collisionacc" id="colacc" value="0.5" step="0.25" min="0.5" max="15" onchange="document.getElementById('colacclb').innerHTML = this.value;" oninput="document.getElementById('colacclb').innerHTML = this.value;">
            <em id="colacclb" style="font-style: normal;">0.5</em>
            <br>
            <label for="collisionchk">Frames Before Collision is Checked:</label>
            <input type="range" name="collisionchk" id="colchk" value="1" min="1" max="10" onchange="document.getElementById('colchklb').innerHTML = this.value;" oninput="document.getElementById('colchklb').innerHTML = this.value;">
            <em id="colchklb" style="font-style: normal;">2</em>
            <br>
            <label for="fps">FPS Throttling (for slower devices):</label>
            <input type="range" name="fps" id="fps" value="30" min="1" max="60" onchange="document.getElementById('fpslb').innerHTML = this.value;" oninput="document.getElementById('fpslb').innerHTML = this.value;">
            <em id="fpslb" style="font-style: normal;">30</em>
            <br>
            <p>Wacky Effects :)</p>
            <label for="fbc">Clear frameBuffer on every frame?</label>
            <input type="checkbox" name="fbc" id="fbc" checked>
            <br>
            <label for="allgrav">Apply gravity to every shape?</label>
            <input type="checkbox" name="allgrav" id="allgrav">
        </div>
        <pre id="phys"></pre>
    </body>
    <script>
        Physics.element = ID("phys");
        Physics.init();
        /*window.onresize = function(){
            Physics.init();
            Physics.clear();
            Physics.render(platform,platform2,platform3,player,tri);
        }*/

        var player = new Physics.shape("box",{height: 9, gravity: true, width: 9, character: "░", x: 0, y:0});
        var titleplayer = new Physics.shape("box",{height: 6, gravity: true, width: 9, character: "░", x: 0, y: 0});

        var numbers = [
            
        ]

        var title = {
            main: new Physics.shape("custom",{mesh:["   ▄███████▄  ▄█          ▄████████     ███        ▄████████  ▄██████▄     ▄████████   ▄▄▄▄███▄▄▄▄      ▄████████ ████████▄  ","  ███    ███ ███         ███    ███ ▀█████████▄   ███    ███ ███    ███   ███    ███ ▄██▀▀▀███▀▀▀██▄   ███    ███ ███   ▀███ ","  ███    ███ ███         ███    ███    ▀███▀▀██   ███    █▀  ███    ███   ███    ███ ███   ███   ███   ███    █▀  ███    ███ ","  ███    ███ ███         ███    ███     ███   ▀  ▄███▄▄▄     ███    ███  ▄███▄▄▄▄██▀ ███   ███   ███  ▄███▄▄▄     ███    ███ ","▀█████████▀  ███       ▀███████████     ███     ▀▀███▀▀▀     ███    ███ ▀▀███▀▀▀▀▀   ███   ███   ███ ▀▀███▀▀▀     ███    ███ ","  ███        ███         ███    ███     ███       ███        ███    ███ ▀███████████ ███   ███   ███   ███    █▄  ███    ███ ","  ███        ███▌    ▄   ███    ███     ███       ███        ███    ███   ███    ███ ███   ███   ███   ███    ███ ███   ▄███ "," ▄████▀      █████▄▄██   ███    █▀     ▄████▀     ███         ▀██████▀    ███    ███  ▀█   ███   █▀    ██████████ ████████▀  ","             ▀                                                            ███    ███                                         "], x: 0, y: 0}),
            subtitle: new Physics.shape("custom",{mesh:["                         ___                                                                        ","_-_ _,,                 -   -_,                               _-_ _,,              ,,               ","   -/  )               (  ~/||    _                              -/  )             ||               ","  ~||_<   '\\\\/\\\\       (  / ||   < \\, ,._-_  /'\\\\ \\\\/\\\\         ~||_<    _-_   _-_ ||/\\  _-_  ,._-_ ","   || \\\\   || ;'        \\/==||   /-||  ||   || || || ||          || \\\\  || \\\\ ||   ||_< || \\\\  ||   ","   ,/--||  ||/          /_ _||  (( ||  ||   || || || ||          ,/--|| ||/   ||   || | ||/    ||   ","  _--_-'   |/          (  - \\\\,  \\/\\\\  \\\\,  \\\\,/  \\\\ \\\\         _--_-'  \\\\,/  \\\\,/ \\\\,\\ \\\\,/   \\\\,  "," (        (                                                    (                                    ","           -_-                                                                                      "], x:0, y:10}),
            startbox: [],
            optsbox: [],
            start: new Physics.shape("custom",{mesh:["  ___ _            _   "," / __| |_ __ _ _ _| |_ "," \\__ \\  _/ _` | '_|  _|"," |___/\\__\\__,_|_|  \\__|","                       "], x:Physics.width-33, y:25}),
            opts: new Physics.shape("custom",{mesh:["   ___       _   _             ","  / _ \\ _ __| |_(_)___ _ _  ___"," | (_) | '_ \\  _| / _ \\ ' \\(_-<","  \\___/| .__/\\__|_\\___/_||_/__/","       |_|                     "], x: 10, y:25}),
            startline: [],
            rightpoint: new Physics.shape("custom",{mesh:["                      >   ","                       >  ","                        > ","------------------------->","                        > ","                       >  ","                      >   "], x: Physics.width-73, y: 45}),
            leftpoint: new Physics.shape("custom",{mesh:["   <                      ","  <                       "," <                        ","<-------------------------"," <                        ","  <                       ","   <                      "], x: 50, y: 45})

        }
        title.main.x = ((Physics.width-title.main.width)/2); //center titles
        title.subtitle.x = ((Physics.width-title.subtitle.width)/2);

        title.startbox = new Physics.shape("box",{height: title.start.height+3, width: title.start.width+3, filled: false, character: "*", x: title.start.x-1, y: title.start.y-1}); //set up boxes around text; has to come later because start isn't initalized yet and render order matters
        title.optsbox = new Physics.shape("box",{height: title.opts.height+3, width: title.opts.width+3, filled: false, character: "*", x: title.opts.x-1, y: title.opts.y-1});
        title.startline = new Physics.shape("box",{height: 2, width: title.startbox.x-(title.optsbox.x+title.optsbox.width)-10, character: "_", x: title.optsbox.x+title.optsbox.width+5, y: title.start.y+2});

        titleplayer.x = ((Physics.width-titleplayer.width)/2);
        titleplayer.y = title.startline.y-titleplayer.height;

        var options = {
            opts: new Physics.shape("custom",{mesh:["   ___       _   _             ","  / _ \\ _ __| |_(_)___ _ _  ___"," | (_) | '_ \\  _| / _ \\ ' \\(_-<","  \\___/| .__/\\__|_\\___/_||_/__/","       |_|                     "], x: 10, y:25})
        }

        var lvl1 = {
            platform: new Physics.shape("line",{length: 50, character: "_", x: 0, y: Physics.height-2}),
            platform2: new Physics.shape("line",{length: 20, character: "_", x: 50, y: Physics.height-10}),
            platform3: new Physics.shape("line",{length: 30, character: "_", x: 70, y: Physics.height-20}),
            tri: new Physics.shape("triangle",{height: 5, character: "⬘", x: 71, y: Physics.height-26})
        };

        var lvl2 = {
            platform: new Physics.shape("line",{length: 20, character: "_", x: 0, y: Physics.height-2})
        }

        var lvl = title;
        var lvlnum = 0;

        Physics.clear();
        titleplayer.control();

        var stats = new Stats();
        stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
        document.body.appendChild( stats.dom );
        stats.dom.style.position = "absolute";
        stats.dom.style.left = (window.innerWidth-stats.dom.offsetWidth)+"px";

        var collisionchk = 2; //amnt of loops before checking collisions again;
        var collchkcount = 0;
        var clearsc = true;

        var frameCount = 0;
        var fpsset, fpsInterval, startTime, now, then, elapsed;
        var started = false;
        var stop = false;
        function beginGame(fps) {
            fpsset = fps;
            fpsInterval = 1000 / fps;
            then = Date.now();
            startTime = then;
            console.log("st: "+startTime);
            console.log("FPS throttling set to "+fps+" fps");
            stop = false;
            gameLoop();
            started = true;
        }
        function setFPS(fps) {
            fpsset = fps;
            if (started) {
                stop = true;
                started = false;
                setTimeout(function(){
                    stop = false;
                    started = true;
                    beginGame(fps);
                },100);
            } else {
                beginGame(fps);
            }
        }
        function changeLvl(lnum) {
            try{
                lvl = eval("lvl"+lnum);
                lvlnum = Number(lnum);
                if (Number(lnum) > 0) {
                    Physics.element.style.lineHeight = String(Physics.lineHeight); //set proper line height of game
                    player.control(); //control player
                }
                player.x = 0;
                player.y = 0;
            } catch(e) {
                try {
                    lvl = eval(lnum);
                    lvlnum = -1;
                    if (lnum == "title" || lnum == "options") {
                        Physics.element.style.lineHeight = String(Physics.initialLineHeight); //set proper line height of game
                        titleplayer.control(); //control player
                        titleplayer.x = 0;
                        titleplayer.y = 0;
                    }
                } catch(e) {
                    console.error("Level '"+lnum+"' has no data; cancelled loading");
                }
            }
        }
        function gameLoop() {

            if (stop) {
                return;
            }
            
            requestAnimationFrame(gameLoop);

            now = Date.now();
            elapsed = now - then;

            if (elapsed > fpsInterval) {
                then = now - (elapsed % fpsInterval);

                stats.begin();

                var renderstr = "Physics.render(clearsc,";
                var collisionstr = "Physics.calculate_collisions(";
                for (var i=0; i<Object.keys(lvl).length; i++) {
                    renderstr+="lvl."+Object.keys(lvl)[i]+",";
                    collisionstr+="lvl."+Object.keys(lvl)[i]+",";
                }
                if (lvlnum > 0) {
                    renderstr+="player);";
                } else {
                    renderstr+="titleplayer);";
                }
                collisionstr+="player);";

                if (collchkcount >= collisionchk) {
                    if (lvlnum > 0) {
                        eval(collisionstr); //lots of lag when run on title sequence
                    } else if (lvlnum == "title" || lvlnum == 0) {
                        if (titleplayer.y > (title.startline.y-5)) {
                            titleplayer.momentumY = -0.25;
                            titleplayer.y-=1;
                        }
                        if (titleplayer.y > (title.startline.y+10)) { //custom collisions
                            titleplayer.momentumY = -3;
                        }
                        if (titleplayer.x < (title.optsbox.x+title.optsbox.width)) { //ADD Y CHECK
                            titleplayer.collisionLeft = true;
                        } else if (titleplayer.x > (title.startbox.x-titleplayer.width)) {
                            titleplayer.collisionRight = true;
                        }
                        if (titleplayer.collisionRight && !titleplayer.collisionLeft) { //start
                            titleplayer.momentumX = 0;
                            changeLvl(1);
                        } else if (!titleplayer.collisionRight && titleplayer.collisionLeft) { //options
                            changeLvl("options");
                        }
                    }
                    collchkcount = 0;
                } else {
                    collchkcount++;
                }

                eval(renderstr);

                stats.end();
            }
        }

        setInterval(function(){
            Physics.collisionAccuracy = Number(document.getElementById("colacc").value);
            collisionchk = Number(document.getElementById("colchk").value);
            if (fpsset != Number(document.getElementById("fps").value) && started == true) {
                setFPS(Number(document.getElementById("fps").value));
            }
            clearsc = (document.getElementById("fbc").checked)?true:false;
            Physics.allGravity = (document.getElementById("allgrav").checked)?true:false;
        },1000);
        
        setInterval(function(){console.log("1b: "+titleplayer.collisionBottom+", t: "+titleplayer.collisionTop+", r: "+titleplayer.collisionRight+", l: "+titleplayer.collisionLeft+", 2"+"b: "+player.collisionBottom+", t: "+player.collisionTop+", r: "+player.collisionRight+", l: "+player.collisionLeft)},100);

        /*var counter = 0;
        var rad = 0;
        var interval = setInterval(function(){
            counter++;
            rad+=0.5;
            var circle = new Physics.shape("circle",{radius: rad, filled:true, character: "o", x: 50, y: 50});
            if (counter >= 100) {
                clearInterval(interval);
            }
            Physics.render(false,circle);
        });*/
    </script>
</html>
